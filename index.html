<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Catan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        #app {
            width: 100%;
            max-width: 1600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .setup-screen {
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }
        
        .setup-screen h1 {
            font-size: 3rem;
            color: #2d3748;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .setup-screen p {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 40px;
        }
        
        .setup-options {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .option-group {
            margin-bottom: 30px;
            text-align: left;
        }
        
        .option-group label {
            display: block;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .option-group select {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        
        .checkbox-group input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-size: 1.1rem;
            color: #2d3748;
            cursor: pointer;
        }
        
        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        
        .game-screen {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            padding: 20px;
            background: #f7fafc;
            min-height: 800px;
        }
        
        .game-header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        
        .game-header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .players-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .player-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .player-card.active {
            border-color: #fbbf24;
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4);
        }
        
        .player-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .player-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #2d3748;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .player-corner {
            margin-left: auto;
            font-size: 0.8rem;
            color: #718096;
        }
        
        .player-vp {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
            margin: 10px 0;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .resource-item {
            background: #f7fafc;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .resource-count {
            font-weight: bold;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 3px;
        }
        
        .resource-name {
            color: #718096;
            font-size: 0.75rem;
        }
        
        .board-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .board-svg {
            width: 100%;
            height: auto;
            max-height: 700px;
        }
        
        .hex {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .hex:hover {
            opacity: 0.9;
        }
        
        .vertex {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vertex:hover {
            opacity: 0.8;
        }
        
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .control-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .dice-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .die {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        
        .die:hover {
            transform: scale(1.05);
        }
        
        .die svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .roll-total {
            font-weight: bold;
            font-size: 1.5rem;
            color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #38a169;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #dd6b20;
        }
        
        .btn-info {
            background: #4299e1;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background: #3182ce;
        }
        
        .btn-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #718096;
        }
        
        .btn.active {
            background: #fc8181;
            transform: scale(0.95);
        }
        
        .cost-label {
            display: block;
            font-size: 0.75rem;
            margin-top: 4px;
            opacity: 0.8;
        }
        
        .message-box {
            padding: 12px;
            background: #edf2f7;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 60px;
            font-size: 0.9rem;
            color: #2d3748;
            line-height: 1.5;
        }
        
        .help-box {
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .help-box h4 {
            font-weight: bold;
            margin-bottom: 8px;
            color: #92400e;
        }
        
        .help-box ul {
            list-style-position: inside;
            color: #78350f;
            line-height: 1.8;
        }
        
        .trade-panel {
            padding: 15px;
            background: #e6fffa;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .trade-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #234e52;
        }
        
        .trade-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .trade-btn {
            padding: 8px;
            font-size: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        
        .trade-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .dev-cards-panel {
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .dev-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #92400e;
        }
        
        .dev-cards-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .dev-card {
            padding: 6px 12px;
            background: #8b5cf6;
            color: white;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        
        .dev-card:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .winner-screen {
            padding: 80px 40px;
            text-align: center;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }
        
        .winner-screen h1 {
            font-size: 3.5rem;
            color: #2d3748;
            margin-bottom: 30px;
        }
        
        .winner-color {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 5px solid #2d3748;
        }
        
        .winner-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .winner-vp {
            font-size: 2rem;
            color: #fbbf24;
            margin-bottom: 40px;
        }
        
        .corner-marker {
            opacity: 0.2;
        }
        
        .stats-line {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 8px;
        }
        
        /* Animations for buildings */
        @keyframes buildingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes buildingAppear {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .building-new {
            animation: buildingAppear 0.6s ease-out;
        }
        
        .building-hover:hover {
            animation: buildingPulse 0.5s ease-in-out;
        }
        
        /* Dice dot animations */
        @keyframes diceRoll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }
        
        .dice-rolling {
            animation: diceRoll 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // Game Constants
        const RESOURCES = ['money', 'garbage', 'energy', 'license'];
        
        const RESOURCE_COLORS = {
            money: '#22c55e',
            garbage: '#6b7280',
            energy: '#3b82f6',
            license: '#e5e7eb'
        };
        
        const RESOURCE_NAMES = {
            money: 'Money',
            garbage: 'Garbage',
            energy: 'Energy',
            license: 'License'
        };
        
        const BUILDING_COSTS = {
            wastePlant: { money: 1, garbage: 1, energy: 1, license: 1 },
            incinerationPlant: { garbage: 2, money: 3 },
            road: { energy: 1, license: 1 },
            devCard: { garbage: 1, energy: 1, money: 1 }
        };
        
        const STARTING_CORNERS = [
            { id: 'major', name: 'Major', x: 100, y: 80, color: '#ef4444' },
            { id: 'builder', name: 'Builder', x: 620, y: 80, color: '#3b82f6' },
            { id: 'investor', name: 'Investor', x: 100, y: 520, color: '#10b981' },
            { id: 'supplier', name: 'Supplier', x: 620, y: 520, color: '#f59e0b' }
        ];
        
        const DEV_CARD_TYPES = {
            knight: 14,
            victory: 5,
            roadBuilding: 2,
            yearOfPlenty: 2,
            monopoly: 2
        };
        
        const BOARD_TILES = [
            { id: 0, type: 'garbage', number: 6, x: 260, y: 90 },
            { id: 1, type: 'money', number: 3, x: 360, y: 90 },
            { id: 2, type: 'license', number: 8, x: 460, y: 90 },
            
            { id: 3, type: 'energy', number: 4, x: 210, y: 177 },
            { id: 4, type: 'license', number: 5, x: 310, y: 177 },
            { id: 5, type: 'garbage', number: 10, x: 410, y: 177 },
            { id: 6, type: 'license', number: 9, x: 510, y: 177 },
            
            { id: 7, type: 'license', number: 11, x: 160, y: 264 },
            { id: 8, type: 'garbage', number: 12, x: 260, y: 264 },
            { id: 9, type: 'desert', number: 0, x: 360, y: 264 },
            { id: 10, type: 'energy', number: 8, x: 460, y: 264 },
            { id: 11, type: 'money', number: 3, x: 560, y: 264 },
            
            { id: 12, type: 'garbage', number: 4, x: 210, y: 351 },
            { id: 13, type: 'money', number: 5, x: 310, y: 351 },
            { id: 14, type: 'license', number: 6, x: 410, y: 351 },
            { id: 15, type: 'energy', number: 9, x: 510, y: 351 },
            
            { id: 16, type: 'garbage', number: 10, x: 260, y: 438 },
            { id: 17, type: 'energy', number: 11, x: 360, y: 438 },
            { id: 18, type: 'money', number: 2, x: 460, y: 438 }
        ];
        
        // Calculate vertices
        function generateVertices() {
            const vertices = [];
            const vertexMap = new Map();
            
            BOARD_TILES.forEach(tile => {
                const angles = [0, 60, 120, 180, 240, 300];
                angles.forEach((angle, i) => {
                    const rad = (angle * Math.PI) / 180;
                    const x = tile.x + Math.cos(rad) * 50;
                    const y = tile.y + Math.sin(rad) * 50;
                    const key = `${Math.round(x)},${Math.round(y)}`;
                    
                    if (!vertexMap.has(key)) {
                        vertexMap.set(key, {
                            id: `v${vertices.length}`,
                            x: Math.round(x),
                            y: Math.round(y),
                            tiles: [tile.id]
                        });
                        vertices.push(vertexMap.get(key));
                    } else {
                        vertexMap.get(key).tiles.push(tile.id);
                    }
                });
            });
            
            return vertices;
        }
        
        const VERTICES = generateVertices();
        
        // Generate edges (connections between vertices for roads)
        function generateEdges() {
            const edges = [];
            const edgeMap = new Map();
            
            BOARD_TILES.forEach(tile => {
                const angles = [0, 60, 120, 180, 240, 300];
                const tileVertices = angles.map((angle) => {
                    const rad = (angle * Math.PI) / 180;
                    const x = Math.round(tile.x + Math.cos(rad) * 50);
                    const y = Math.round(tile.y + Math.sin(rad) * 50);
                    return VERTICES.find(v => Math.abs(v.x - x) < 1 && Math.abs(v.y - y) < 1);
                }).filter(v => v);
                
                // Connect adjacent vertices around the hexagon
                for (let i = 0; i < tileVertices.length; i++) {
                    const v1 = tileVertices[i];
                    const v2 = tileVertices[(i + 1) % tileVertices.length];
                    if (v1 && v2) {
                        const edgeKey = [v1.id, v2.id].sort().join('-');
                        if (!edgeMap.has(edgeKey)) {
                            edgeMap.set(edgeKey, {
                                id: `e${edges.length}`,
                                v1: v1.id,
                                v2: v2.id,
                                x1: v1.x,
                                y1: v1.y,
                                x2: v2.x,
                                y2: v2.y
                            });
                            edges.push(edgeMap.get(edgeKey));
                        }
                    }
                }
            });
            
            return edges;
        }
        
        const EDGES = generateEdges();
        
        // Enhanced Resource Pattern Rendering with Stylized Landscapes
        function renderResourcePattern(tile) {
            const patternId = `pattern-${tile.type}-${tile.id}`;
            const color = tile.type === 'desert' ? '#fbbf24' : RESOURCE_COLORS[tile.type];
            
            let patternContent = '';
            
            if (tile.type === 'money') {
                // Gold bars landscape
                patternContent = `
                    <defs>
                        <pattern id="${patternId}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="${color}"/>
                            <!-- Gold bar 1 -->
                            <rect x="8" y="12" width="24" height="8" fill="#fbbf24" stroke="#d97706" stroke-width="1" rx="1"/>
                            <rect x="10" y="13" width="20" height="2" fill="#fde047" opacity="0.6"/>
                            <!-- Gold bar 2 -->
                            <rect x="12" y="22" width="16" height="6" fill="#fbbf24" stroke="#d97706" stroke-width="1" rx="1"/>
                            <rect x="14" y="23" width="12" height="1.5" fill="#fde047" opacity="0.6"/>
                            <!-- Sparkle effects -->
                            <circle cx="14" cy="15" r="1" fill="#fef08a"/>
                            <circle cx="26" cy="17" r="0.8" fill="#fef08a"/>
                            <circle cx="20" cy="25" r="0.7" fill="#fef08a"/>
                        </pattern>
                    </defs>
                `;
            } else if (tile.type === 'garbage') {
                // Recycling bins landscape
                patternContent = `
                    <defs>
                        <pattern id="${patternId}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="${color}"/>
                            <!-- Recycling bin -->
                            <rect x="12" y="16" width="16" height="18" fill="#9ca3af" stroke="#374151" stroke-width="1.2" rx="1"/>
                            <rect x="13" y="17" width="14" height="2" fill="#4b5563"/>
                            <!-- Recycling symbol -->
                            <path d="M 20 22 L 22 26 L 18 26 Z" fill="#10b981" stroke="#059669" stroke-width="0.5"/>
                            <path d="M 23 24 L 25 20 L 23 20 Z" fill="#10b981" stroke="#059669" stroke-width="0.5"/>
                            <path d="M 17 24 L 15 20 L 17 20 Z" fill="#10b981" stroke="#059669" stroke-width="0.5"/>
                            <!-- Arrow details -->
                            <circle cx="20" cy="24" r="1.5" fill="none" stroke="#10b981" stroke-width="0.8"/>
                        </pattern>
                    </defs>
                `;
            } else if (tile.type === 'energy') {
                // Power lines landscape
                patternContent = `
                    <defs>
                        <pattern id="${patternId}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="${color}"/>
                            <!-- Power line poles -->
                            <rect x="10" y="18" width="2" height="16" fill="#475569"/>
                            <rect x="28" y="18" width="2" height="16" fill="#475569"/>
                            <!-- Cross beams -->
                            <rect x="7" y="18" width="8" height="1.5" fill="#475569"/>
                            <rect x="25" y="18" width="8" height="1.5" fill="#475569"/>
                            <!-- Power lines -->
                            <path d="M 11 20 Q 20 23 29 20" stroke="#fbbf24" stroke-width="1.2" fill="none"/>
                            <path d="M 11 22 Q 20 25 29 22" stroke="#fbbf24" stroke-width="1.2" fill="none"/>
                            <path d="M 11 24 Q 20 27 29 24" stroke="#fbbf24" stroke-width="1.2" fill="none"/>
                            <!-- Lightning bolt accent -->
                            <path d="M 20 12 L 18 17 L 21 17 L 19 22" stroke="#fef08a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        </pattern>
                    </defs>
                `;
            } else if (tile.type === 'license') {
                // Certificates/official seals landscape
                patternContent = `
                    <defs>
                        <pattern id="${patternId}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="${color}"/>
                            <!-- Certificate document -->
                            <rect x="10" y="12" width="20" height="20" fill="white" stroke="#94a3b8" stroke-width="1.5" rx="2"/>
                            <!-- Header line -->
                            <line x1="13" y1="16" x2="27" y2="16" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
                            <!-- Text lines -->
                            <line x1="13" y1="20" x2="27" y2="20" stroke="#cbd5e0" stroke-width="1"/>
                            <line x1="13" y1="23" x2="24" y2="23" stroke="#cbd5e0" stroke-width="1"/>
                            <line x1="13" y1="26" x2="27" y2="26" stroke="#cbd5e0" stroke-width="1"/>
                            <!-- Official seal -->
                            <circle cx="23" cy="28" r="3" fill="none" stroke="#ef4444" stroke-width="1.2"/>
                            <circle cx="23" cy="28" r="1.5" fill="#ef4444" opacity="0.3"/>
                            <!-- Ribbon -->
                            <path d="M 23 31 L 22 34 L 23 33 L 24 34 Z" fill="#ef4444"/>
                        </pattern>
                    </defs>
                `;
            } else {
                // Desert (default pattern)
                patternContent = `
                    <defs>
                        <pattern id="${patternId}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="${color}"/>
                            <!-- Sand dunes -->
                            <path d="M 0 25 Q 10 20 20 25 T 40 25 L 40 40 L 0 40 Z" fill="#f59e0b" opacity="0.4"/>
                            <path d="M 0 30 Q 15 26 30 30 T 40 30 L 40 40 L 0 40 Z" fill="#d97706" opacity="0.3"/>
                        </pattern>
                    </defs>
                `;
            }
            
            return patternContent;
        }
        
        // Render symbolic dice with dots instead of numbers
        function renderDiceDots(value) {
            const dotPatterns = {
                1: [[20, 20]],
                2: [[12, 12], [28, 28]],
                3: [[12, 12], [20, 20], [28, 28]],
                4: [[12, 12], [28, 12], [12, 28], [28, 28]],
                5: [[12, 12], [28, 12], [20, 20], [12, 28], [28, 28]],
                6: [[12, 12], [28, 12], [12, 20], [28, 20], [12, 28], [28, 28]]
            };
            
            const dots = dotPatterns[value] || [];
            return `
                <svg width="40" height="40" viewBox="0 0 40 40" style="display: block;">
                    <rect width="40" height="40" rx="6" fill="white" stroke="#2d3748" stroke-width="2"/>
                    ${dots.map(([cx, cy]) => `
                        <circle cx="${cx}" cy="${cy}" r="3" fill="#2d3748"/>
                    `).join('')}
                </svg>
            `;
        }
        
        // Render building symbols
        function renderWastePlantSymbol(x, y, color, isNew = false) {
            return `
                <g class="${isNew ? 'building-new' : 'building-hover'}" transform="translate(${x}, ${y})">
                    <!-- Waste plant chimney -->
                    <rect x="-6" y="-12" width="4" height="12" fill="${color}" stroke="#2d3748" stroke-width="1.5"/>
                    <!-- Building base -->
                    <rect x="-10" y="-6" width="12" height="10" fill="${color}" stroke="#2d3748" stroke-width="1.5" rx="1"/>
                    <!-- Smoke from chimney -->
                    <circle cx="-4" cy="-14" r="2" fill="#cbd5e0" opacity="0.6"/>
                    <circle cx="-3" cy="-16" r="1.5" fill="#cbd5e0" opacity="0.5"/>
                    <!-- Door -->
                    <rect x="-6" y="-2" width="4" height="5" fill="#1f2937"/>
                    <!-- Window -->
                    <rect x="-2" y="-4" width="2" height="2" fill="#fbbf24" opacity="0.8"/>
                </g>
            `;
        }
        
        function renderIncinerationPlantSymbol(x, y, color, isNew = false) {
            return `
                <g class="${isNew ? 'building-new' : 'building-hover'}" transform="translate(${x}, ${y})">
                    <!-- Main structure -->
                    <rect x="-12" y="-10" width="16" height="14" fill="${color}" stroke="#2d3748" stroke-width="2" rx="1"/>
                    <!-- Tall chimney -->
                    <rect x="-10" y="-18" width="5" height="10" fill="${color}" stroke="#2d3748" stroke-width="1.5"/>
                    <rect x="1" y="-16" width="4" height="8" fill="${color}" stroke="#2d3748" stroke-width="1.5"/>
                    <!-- Smoke -->
                    <circle cx="-7" cy="-20" r="2.5" fill="#94a3b8" opacity="0.7"/>
                    <circle cx="-6" cy="-23" r="2" fill="#94a3b8" opacity="0.6"/>
                    <circle cx="3" cy="-18" r="2" fill="#94a3b8" opacity="0.6"/>
                    <!-- Windows -->
                    <rect x="-9" y="-6" width="3" height="3" fill="#fbbf24" opacity="0.9"/>
                    <rect x="-5" y="-6" width="3" height="3" fill="#fbbf24" opacity="0.9"/>
                    <rect x="-9" y="-2" width="3" height="3" fill="#fbbf24" opacity="0.9"/>
                    <!-- Fire symbol -->
                    <path d="M -1 -4 L 0 -7 L 1 -4 Z" fill="#ef4444"/>
                </g>
            `;
        }
        
        function renderRoadSymbol(x1, y1, x2, y2, color) {
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;
            return `
                <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                    stroke="${color}" stroke-width="6" stroke-linecap="round" opacity="0.8"/>
                <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                    stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
            `;
        }

        
        // Create development card deck
        function createDevCardDeck() {
            const deck = [];
            Object.entries(DEV_CARD_TYPES).forEach(([type, count]) => {
                for (let i = 0; i < count; i++) {
                    deck.push(type);
                }
            });
            return deck.sort(() => Math.random() - 0.5);
        }
        
        // Game State
        let gameState = {
            screen: 'setup',
            numPlayers: 3,
            robberEnabled: false,
            players: [],
            currentPlayer: 0,
            phase: 1, // Phase 1: Initial placement, Phase 2: Normal game
            placementRound: 1, // Track which round of initial placement (1 or 2)
            dice: [1, 1],
            lastRoll: null,
            diceRolling: false,
            message: 'üåç Welcome to Energy Catan! Build a sustainable energy empire! üåç',
            buildMode: null,
            robberTile: 9,
            robberPlayer: null, // Track who placed the robber for bonus resources
            devCardDeck: [],
            tradeMode: null,
            tradingResource: null,
            winner: null
        };
        
        // Initialize players
        function initializePlayers(count) {
            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];
            return Array.from({ length: count }, (_, i) => ({
                name: `Player ${i + 1}`,
                resources: { money: 0, garbage: 0, energy: 0, license: 0 }, // Start with no resources
                wastePlants: [],
                incinerationPlants: [],
                roads: [],
                devCards: [],
                playedDevCards: [],
                vp: 0,
                knights: 0,
                longestRoad: false,
                largestArmy: false,
                color: colors[i],
                startingCorner: STARTING_CORNERS[i]
            }));
        }
        
        // Check if player can afford building
        function canAfford(player, building) {
            const cost = BUILDING_COSTS[building];
            return Object.entries(cost).every(([resource, amount]) => 
                (player.resources[resource] || 0) >= amount
            );
        }
        
        // Pay for building
        function payForBuilding(player, building) {
            const cost = BUILDING_COSTS[building];
            Object.entries(cost).forEach(([resource, amount]) => {
                player.resources[resource] -= amount;
            });
        }
        
        // Roll dice
        function rollDice() {
            // Add rolling animation
            gameState.diceRolling = true;
            render();
            
            setTimeout(() => {
                const d1 = Math.floor(Math.random() * 6) + 1;
                const d2 = Math.floor(Math.random() * 6) + 1;
                gameState.dice = [d1, d2];
                gameState.lastRoll = d1 + d2;
                gameState.diceRolling = false;
                
                if (gameState.robberEnabled && gameState.lastRoll === 7) {
                    gameState.message = `üé≤ Rolled 7! üëπ Move the robber to a new tile (click on a hexagon).`;
                    gameState.buildMode = 'robber';
                    gameState.robberPlayer = gameState.currentPlayer; // Track who rolled 7
                    render();
                    return;
                }
                
                // Distribute resources
                gameState.players.forEach(player => {
                    player.wastePlants.forEach(plantId => {
                        const vertex = VERTICES.find(v => v.id === plantId);
                        if (vertex) {
                            vertex.tiles.forEach(tileId => {
                                const tile = BOARD_TILES.find(t => t.id === tileId);
                                if (tile && tile.number === gameState.lastRoll && 
                                    (!gameState.robberEnabled || gameState.robberTile !== tileId)) {
                                    if (player.resources[tile.type] !== undefined) {
                                        player.resources[tile.type]++;
                                    }
                                }
                            });
                        }
                    });
                    
                    player.incinerationPlants.forEach(plantId => {
                        const vertex = VERTICES.find(v => v.id === plantId);
                        if (vertex) {
                            vertex.tiles.forEach(tileId => {
                                const tile = BOARD_TILES.find(t => t.id === tileId);
                                if (tile && tile.number === gameState.lastRoll && 
                                    (!gameState.robberEnabled || gameState.robberTile !== tileId)) {
                                    if (player.resources[tile.type] !== undefined) {
                                        player.resources[tile.type] += 2;
                                    }
                                }
                            });
                        }
                    });
                });
                
                gameState.message = `üé≤ Rolled ${gameState.lastRoll}! Resources distributed to players.`;
                render();
            }, 500);
        }
        
        // Build waste plant
        function buildWastePlant(vertexId) {
            const player = gameState.players[gameState.currentPlayer];
            
            // Phase 1: Free placement
            if (gameState.phase === 1) {
                const occupied = gameState.players.some(p => 
                    p.wastePlants.includes(vertexId) || p.incinerationPlants.includes(vertexId)
                );
                
                if (occupied) {
                    gameState.message = 'üö´ This location is already occupied!';
                    render();
                    return;
                }
                
                player.wastePlants.push(vertexId);
                player.vp++;
                
                gameState.message = `üè≠ ${player.name} placed a Waste Plant!`;
                gameState.buildMode = null;
                advanceToNextPlayer();
                render();
                return;
            }
            
            // Phase 2: Normal building with resources
            if (!canAfford(player, 'wastePlant')) {
                gameState.message = '‚ùå Not enough resources to build Waste Plant! Check the costs.';
                render();
                return;
            }
            
            const occupied = gameState.players.some(p => 
                p.wastePlants.includes(vertexId) || p.incinerationPlants.includes(vertexId)
            );
            
            if (occupied) {
                gameState.message = 'üö´ This location is already occupied!';
                render();
                return;
            }
            
            payForBuilding(player, 'wastePlant');
            player.wastePlants.push(vertexId);
            player.vp++;
            
            checkWinner(player);
            gameState.message = `üè≠ ${player.name} built a Waste Plant! +1 VP ‚≠ê (Total: ${player.vp} VP)`;
            gameState.buildMode = null;
            render();
        }
        
        // Build incineration plant
        function buildIncinerationPlant(vertexId) {
            const player = gameState.players[gameState.currentPlayer];
            
            if (!canAfford(player, 'incinerationPlant')) {
                gameState.message = '‚ùå Not enough resources to build Incineration Plant!';
                render();
                return;
            }
            
            if (!player.wastePlants.includes(vertexId)) {
                gameState.message = '‚ö†Ô∏è You need a Waste Plant here first to upgrade!';
                render();
                return;
            }
            
            payForBuilding(player, 'incinerationPlant');
            player.wastePlants = player.wastePlants.filter(id => id !== vertexId);
            player.incinerationPlants.push(vertexId);
            player.vp++;
            
            checkWinner(player);
            gameState.message = `üè¢ ${player.name} built an Incineration Plant! +1 VP ‚≠ê (Total: ${player.vp} VP)`;
            gameState.buildMode = null;
            render();
        }
        
        // Build road
        function buildRoad(edgeId) {
            const player = gameState.players[gameState.currentPlayer];
            
            // Phase 1: Free placement
            if (gameState.phase === 1) {
                const occupied = gameState.players.some(p => p.roads.includes(edgeId));
                
                if (occupied) {
                    gameState.message = 'üö´ A road already exists here!';
                    render();
                    return;
                }
                
                // Check connection to player's waste plant or existing roads
                player.roads.push(edgeId);
                gameState.message = `üõ£Ô∏è ${player.name} placed a road!`;
                gameState.buildMode = null;
                advanceToNextPlayer();
                render();
                return;
            }
            
            // Phase 2: Normal building with resources
            if (!canAfford(player, 'road')) {
                gameState.message = '‚ùå Not enough resources to build Road!';
                render();
                return;
            }
            
            // Check if edge is already occupied
            const occupied = gameState.players.some(p => p.roads.includes(edgeId));
            
            if (occupied) {
                gameState.message = 'üö´ A road already exists here!';
                render();
                return;
            }
            
            payForBuilding(player, 'road');
            player.roads.push(edgeId);
            
            checkLongestRoad();
            gameState.message = `üõ£Ô∏è ${player.name} built a Road!`;
            gameState.buildMode = null;
            render();
        }
        
        // Advance to next player during initial placement
        function advanceToNextPlayer() {
            const totalPlayers = gameState.players.length;
            const itemsPerPlayer = 4; // 1 waste plant + 3 roads
            
            // Count total items placed by current player in current round
            const player = gameState.players[gameState.currentPlayer];
            const roundOffset = (gameState.placementRound - 1) * itemsPerPlayer;
            const plantsThisRound = Math.max(0, player.wastePlants.length - (gameState.placementRound - 1));
            const roadsThisRound = Math.max(0, player.roads.length - (gameState.placementRound - 1) * 3);
            const itemsPlacedThisRound = plantsThisRound + roadsThisRound;
            
            // Determine what to place next
            if (itemsPlacedThisRound < itemsPerPlayer) {
                // Player still needs to place more items - switch to next player
                if (gameState.placementRound === 1) {
                    // Round 1: move forward
                    gameState.currentPlayer = (gameState.currentPlayer + 1) % totalPlayers;
                } else {
                    // Round 2: move backward
                    gameState.currentPlayer = (gameState.currentPlayer - 1 + totalPlayers) % totalPlayers;
                }
                
                const nextPlayer = gameState.players[gameState.currentPlayer];
                const nextPlayerPlantsThisRound = Math.max(0, nextPlayer.wastePlants.length - (gameState.placementRound - 1));
                const nextPlayerRoadsThisRound = Math.max(0, nextPlayer.roads.length - (gameState.placementRound - 1) * 3);
                
                // Determine what the next player should place
                if (nextPlayerPlantsThisRound === 0) {
                    gameState.buildMode = 'wastePlant';
                    gameState.message = `üè≠ ${nextPlayer.name}'s turn! Place a Waste Plant.`;
                } else {
                    gameState.buildMode = 'road';
                    const roadsRemaining = 3 - nextPlayerRoadsThisRound;
                    gameState.message = `üõ£Ô∏è ${nextPlayer.name}'s turn! Place a road (${roadsRemaining} more needed).`;
                }
                
                render();
                return;
            }
            
            // Check if round is complete (all players placed all items)
            let roundComplete = true;
            for (let i = 0; i < totalPlayers; i++) {
                const p = gameState.players[i];
                const pPlantsThisRound = Math.max(0, p.wastePlants.length - (gameState.placementRound - 1));
                const pRoadsThisRound = Math.max(0, p.roads.length - (gameState.placementRound - 1) * 3);
                if (pPlantsThisRound + pRoadsThisRound < itemsPerPlayer) {
                    roundComplete = false;
                    break;
                }
            }
            
            if (roundComplete) {
                if (gameState.placementRound === 1) {
                    // Start round 2
                    gameState.placementRound = 2;
                    gameState.currentPlayer = totalPlayers - 1;
                    gameState.buildMode = 'wastePlant';
                    gameState.message = `üîÑ Round 2! ${gameState.players[gameState.currentPlayer].name}'s turn! Place a Waste Plant.`;
                } else {
                    // Both rounds complete, start Phase 2
                    startPhase2();
                }
            } else {
                // Continue with next player in sequence
                if (gameState.placementRound === 1) {
                    gameState.currentPlayer = (gameState.currentPlayer + 1) % totalPlayers;
                } else {
                    gameState.currentPlayer = (gameState.currentPlayer - 1 + totalPlayers) % totalPlayers;
                }
                
                const nextPlayer = gameState.players[gameState.currentPlayer];
                const nextPlayerPlantsThisRound = Math.max(0, nextPlayer.wastePlants.length - (gameState.placementRound - 1));
                const nextPlayerRoadsThisRound = Math.max(0, nextPlayer.roads.length - (gameState.placementRound - 1) * 3);
                
                if (nextPlayerPlantsThisRound === 0) {
                    gameState.buildMode = 'wastePlant';
                    gameState.message = `üè≠ ${nextPlayer.name}'s turn! Place a Waste Plant.`;
                } else {
                    gameState.buildMode = 'road';
                    const roadsRemaining = 3 - nextPlayerRoadsThisRound;
                    gameState.message = `üõ£Ô∏è ${nextPlayer.name}'s turn! Place a road (${roadsRemaining} more needed).`;
                }
            }
            
            render();
        }
        
        // Start Phase 2 (normal game)
        function startPhase2() {
            gameState.phase = 2;
            gameState.currentPlayer = 0;
            gameState.buildMode = null;
            
            // Give starting resources from second placement
            gameState.players.forEach(player => {
                player.resources = { money: 2, garbage: 2, energy: 2, license: 2 };
            });
            
            gameState.message = `üéÆ Phase 2 begins! ${gameState.players[0].name}'s turn! üé≤ Roll the dice to start!`;
        }
        
        // Check for longest road (simplified - counts total roads)
        function checkLongestRoad() {
            const roadCounts = gameState.players.map(p => ({
                player: p,
                count: p.roads.length
            }));
            
            const maxRoads = Math.max(...roadCounts.map(r => r.count));
            
            if (maxRoads >= 5) {
                gameState.players.forEach(p => {
                    const hadLongestRoad = p.longestRoad;
                    const hasLongestRoad = p.roads.length === maxRoads && p.roads.length >= 5;
                    
                    if (hasLongestRoad && !hadLongestRoad) {
                        p.longestRoad = true;
                        p.vp += 2;
                        checkWinner(p);
                    } else if (!hasLongestRoad && hadLongestRoad) {
                        p.longestRoad = false;
                        p.vp -= 2;
                    }
                });
            }
        }
        
        // Buy development card
        function buyDevCard() {
            const player = gameState.players[gameState.currentPlayer];
            
            if (!canAfford(player, 'devCard')) {
                gameState.message = 'Not enough resources for development card!';
                render();
                return;
            }
            
            if (gameState.devCardDeck.length === 0) {
                gameState.message = 'No more development cards available!';
                render();
                return;
            }
            
            payForBuilding(player, 'devCard');
            const card = gameState.devCardDeck.shift();
            player.devCards.push(card);
            
            if (card === 'victory') {
                player.vp++;
                checkWinner(player);
            }
            
            gameState.message = `üé¥ ${player.name} bought a development card: ${card}!`;
            render();
        }
        
        // Play development card
        function playDevCard(cardType) {
            const player = gameState.players[gameState.currentPlayer];
            const cardIndex = player.devCards.indexOf(cardType);
            
            if (cardIndex === -1) return;
            
            player.devCards.splice(cardIndex, 1);
            player.playedDevCards.push(cardType);
            
            if (cardType === 'knight') {
                player.knights++;
                checkLargestArmy();
                
                if (gameState.robberEnabled) {
                    gameState.message = `‚öîÔ∏è ${player.name} played a Knight! üëπ Move the robber to steal resources (click on a hexagon). You'll get 2x resources from that tile!`;
                    gameState.buildMode = 'robber';
                    gameState.robberPlayer = gameState.currentPlayer;
                } else {
                    gameState.message = `‚öîÔ∏è ${player.name} played a Knight! (Robber mechanic is disabled, so no robber movement)`;
                }
            } else if (cardType === 'roadBuilding') {
                gameState.message = `üõ£Ô∏è ${player.name} played Road Building! (Feature coming soon)`;
            } else if (cardType === 'yearOfPlenty') {
                gameState.message = `üåæ ${player.name} played Year of Plenty! (Feature coming soon)`;
            } else if (cardType === 'monopoly') {
                gameState.message = `üí∞ ${player.name} played Monopoly! (Feature coming soon)`;
            }
            
            render();
        }
        
        // Check for largest army
        function checkLargestArmy() {
            const maxKnights = Math.max(...gameState.players.map(p => p.knights));
            
            if (maxKnights >= 3) {
                gameState.players.forEach(p => {
                    const hadLargestArmy = p.largestArmy;
                    const hasLargestArmy = p.knights === maxKnights && p.knights >= 3;
                    
                    if (hasLargestArmy && !hadLargestArmy) {
                        p.largestArmy = true;
                        p.vp += 2;
                        checkWinner(p);
                    } else if (!hasLargestArmy && hadLargestArmy) {
                        p.largestArmy = false;
                        p.vp -= 2;
                    }
                });
            }
        }
        
        // Bank trade
        function startBankTrade(resource) {
            const player = gameState.players[gameState.currentPlayer];
            
            if ((player.resources[resource] || 0) < 4) {
                gameState.message = `‚ùå Need 4 ${RESOURCE_NAMES[resource]} to trade with bank!`;
                render();
                return;
            }
            
            player.resources[resource] -= 4;
            gameState.tradingResource = resource;
            gameState.message = `üè¶ Select a resource to receive from the bank:`;
            render();
        }
        
        function completeBankTrade(getResource) {
            const player = gameState.players[gameState.currentPlayer];
            player.resources[getResource]++;
            gameState.message = `‚úÖ Traded 4 ${RESOURCE_NAMES[gameState.tradingResource]} for 1 ${RESOURCE_NAMES[getResource]}!`;
            gameState.tradeMode = null;
            gameState.tradingResource = null;
            render();
        }
        
        // Move robber
        function moveRobber(tileId) {
            if (tileId === gameState.robberTile) {
                gameState.message = 'üö´ Robber must move to a different tile!';
                render();
                return;
            }
            
            const tile = BOARD_TILES.find(t => t.id === tileId);
            gameState.robberTile = tileId;
            
            // Give double resources from the robber tile to the player who placed it (knight player)
            if (gameState.robberPlayer !== null && tile.type !== 'desert') {
                const robberPlayer = gameState.players[gameState.robberPlayer];
                if (robberPlayer.resources[tile.type] !== undefined) {
                    robberPlayer.resources[tile.type] += 2;
                    gameState.message = `üëπ Robber moved to ${RESOURCE_NAMES[tile.type]}! ${robberPlayer.name} received 2x ${RESOURCE_NAMES[tile.type]} resources! üí∞`;
                } else {
                    gameState.message = `üëπ Robber moved to ${tile.type === 'desert' ? 'desert' : RESOURCE_NAMES[tile.type]}!`;
                }
            } else {
                gameState.message = `üëπ Robber moved to ${tile.type === 'desert' ? 'desert' : RESOURCE_NAMES[tile.type]}!`;
            }
            
            gameState.buildMode = null;
            gameState.robberPlayer = null; // Reset robber player after moving
            render();
        }
        
        // Check winner
        function checkWinner(player) {
            if (player.vp >= 10) {
                gameState.screen = 'winner';
                gameState.winner = player;
            }
        }
        
        // End turn
        function endTurn() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            gameState.buildMode = null;
            gameState.tradeMode = null;
            gameState.tradingResource = null;
            gameState.message = `üéØ ${gameState.players[gameState.currentPlayer].name}'s turn! Roll the dice to begin. üé≤`;
            render();
        }
        
        // Render functions
        function renderSetupScreen() {
            return `
                <div class="setup-screen">
                    <h1>‚ö° Energy Catan ‚ö°</h1>
                    <p>üåç Build a sustainable energy empire! üè≠</p>
                    
                    <div class="setup-options">
                        <div class="option-group">
                            <label for="numPlayers">üë• Number of Players:</label>
                            <select id="numPlayers" onchange="gameState.numPlayers = parseInt(this.value)">
                                <option value="2">2 Players</option>
                                <option value="3" selected>3 Players</option>
                                <option value="4">4 Players</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="robberToggle" 
                                ${gameState.robberEnabled ? 'checked' : ''}
                                onchange="gameState.robberEnabled = this.checked">
                            <label for="robberToggle">üëπ Enable Robber Mechanic</label>
                        </div>
                        
                        <button class="start-button" onclick="startGame()">
                            üéÆ Start Game üéÆ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderHexagon(tile) {
            const points = Array.from({ length: 6 }, (_, i) => {
                const angle = (60 * i - 30) * Math.PI / 180;
                const x = tile.x + Math.cos(angle) * 50;
                const y = tile.y + Math.sin(angle) * 50;
                return `${x},${y}`;
            }).join(' ');
            
            const hasRobber = gameState.robberEnabled && gameState.robberTile === tile.id;
            const patternId = `pattern-${tile.type}-${tile.id}`;
            
            return `
                ${renderResourcePattern(tile)}
                <g class="hex" onclick="${gameState.buildMode === 'robber' ? `moveRobber(${tile.id})` : ''}">
                    <polygon points="${points}" fill="url(#${patternId})" stroke="#2d3748" stroke-width="3"/>
                    ${tile.number > 0 ? `
                        <circle cx="${tile.x}" cy="${tile.y}" r="20" fill="white" stroke="#2d3748" stroke-width="2"/>
                        <text x="${tile.x}" y="${tile.y + 7}" text-anchor="middle" 
                            font-size="20" font-weight="bold" 
                            fill="${tile.number === 6 || tile.number === 8 ? '#dc2626' : '#2d3748'}">
                            ${tile.number}
                        </text>
                        ${tile.number === 6 || tile.number === 8 ? `
                            <circle cx="${tile.x}" cy="${tile.y}" r="24" fill="none" stroke="#dc2626" stroke-width="1.5" opacity="0.5"/>
                        ` : ''}
                    ` : ''}
                    ${hasRobber ? `
                        <circle cx="${tile.x}" cy="${tile.y}" r="15" fill="#1f2937" stroke="#000" stroke-width="2"/>
                        <circle cx="${tile.x - 3}" cy="${tile.y - 2}" r="2" fill="#dc2626"/>
                        <circle cx="${tile.x + 3}" cy="${tile.y - 2}" r="2" fill="#dc2626"/>
                    ` : ''}
                </g>
            `;
        }
        
        function renderVertex(vertex) {
            const wastePlant = gameState.players.find(p => p.wastePlants.includes(vertex.id));
            const incinerationPlant = gameState.players.find(p => p.incinerationPlants.includes(vertex.id));
            
            const onClick = gameState.buildMode === 'wastePlant' ? `buildWastePlant('${vertex.id}')` :
                           gameState.buildMode === 'incinerationPlant' ? `buildIncinerationPlant('${vertex.id}')` : '';
            
            // Check if this is a newly built structure
            const isNew = false; // We'll track this in game state if needed
            
            return `
                <g class="vertex" onclick="${onClick}">
                    ${!wastePlant && !incinerationPlant ? `
                        <circle cx="${vertex.x}" cy="${vertex.y}" r="8" 
                            fill="white" stroke="#2d3748" stroke-width="2.5" opacity="0.7"/>
                    ` : ''}
                    ${wastePlant ? renderWastePlantSymbol(vertex.x, vertex.y, wastePlant.color, isNew) : ''}
                    ${incinerationPlant ? renderIncinerationPlantSymbol(vertex.x, vertex.y, incinerationPlant.color, isNew) : ''}
                </g>
            `;
        }

        
        function renderEdge(edge) {
            const road = gameState.players.find(p => p.roads.includes(edge.id));
            const onClick = gameState.buildMode === 'road' ? `buildRoad('${edge.id}')` : '';
            
            if (road) {
                // Render built road
                return renderRoadSymbol(edge.x1, edge.y1, edge.x2, edge.y2, road.color);
            } else if (gameState.buildMode === 'road') {
                // Show available road spots when in build mode - made MUCH more visible
                return `
                    <line x1="${edge.x1}" y1="${edge.y1}" x2="${edge.x2}" y2="${edge.y2}" 
                        stroke="#64748b" stroke-width="6" stroke-linecap="round" opacity="0.7"
                        stroke-dasharray="5,5"
                        style="cursor: pointer; filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));" onclick="${onClick}"/>
                `;
            }
            return '';
        }

        
        function renderGameScreen() {
            const player = gameState.players[gameState.currentPlayer];
            
            return `
                <div class="game-screen">
                    <div class="game-header">
                        <h1>‚ö° Energy Catan ‚ö°</h1>
                        <div>Turn: ${gameState.currentPlayer + 1} | First to 10 VP wins!</div>
                    </div>
                    
                    <div class="players-panel">
                        ${gameState.players.map((p, idx) => `
                            <div class="player-card ${idx === gameState.currentPlayer ? 'active' : ''}">
                                <div class="player-header">
                                    <div class="player-color" style="background: ${p.color}"></div>
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-corner">${p.startingCorner.name}</div>
                                </div>
                                <div class="player-vp">‚≠ê ${p.vp} VP</div>
                                <div class="resources-grid">
                                    ${RESOURCES.map(r => `
                                        <div class="resource-item" style="background: ${RESOURCE_COLORS[r]}15">
                                            <span class="resource-count">${p.resources[r] || 0}</span>
                                            <span class="resource-name">${RESOURCE_NAMES[r]}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${p.knights > 0 ? `
                                    <div class="stats-line">
                                        ‚öîÔ∏è ${p.knights} Knights ${p.largestArmy ? '(Largest Army +2 VP)' : ''}
                                    </div>
                                ` : ''}
                                ${p.roads.length > 0 ? `
                                    <div class="stats-line">
                                        üõ£Ô∏è ${p.roads.length} Roads ${p.longestRoad ? '(Longest Road +2 VP)' : ''}
                                    </div>
                                ` : ''}
                                ${p.devCards.length > 0 ? `
                                    <div class="stats-line">üé¥ ${p.devCards.length} Dev Cards</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="board-container">
                        <svg class="board-svg" viewBox="0 0 720 600" xmlns="http://www.w3.org/2000/svg">
                            ${STARTING_CORNERS.map(corner => `
                                <g class="corner-marker">
                                    <circle cx="${corner.x}" cy="${corner.y}" r="40" 
                                        fill="${corner.color}" stroke="#2d3748" stroke-width="3"/>
                                    <text x="${corner.x}" y="${corner.y + 6}" text-anchor="middle" 
                                        font-size="14" font-weight="bold" fill="white">
                                        ${corner.name}
                                    </text>
                                </g>
                            `).join('')}
                            
                            ${BOARD_TILES.map(tile => renderHexagon(tile)).join('')}
                            ${EDGES.map(edge => renderEdge(edge)).join('')}
                            ${VERTICES.map(vertex => renderVertex(vertex)).join('')}
                        </svg>
                    </div>
                    
                    <div class="controls-panel">
                        <div class="control-card">
                            <div class="control-title">${player.name}'s Turn</div>
                            
                            ${gameState.phase === 2 ? `
                                <div class="dice-container">
                                    <div class="die ${gameState.diceRolling ? 'dice-rolling' : ''}">${renderDiceDots(gameState.dice[0])}</div>
                                    <div class="die ${gameState.diceRolling ? 'dice-rolling' : ''}">${renderDiceDots(gameState.dice[1])}</div>
                                    ${gameState.lastRoll ? `<div class="roll-total">= ${gameState.lastRoll}</div>` : ''}
                                    <button class="btn btn-primary" onclick="rollDice()" style="margin: 0; padding: 8px 16px;">
                                        üé≤ Roll
                                    </button>
                                </div>
                            ` : `
                                <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>üèóÔ∏è Phase 1: Initial Placement</strong><br>
                                    <small>Each player places 1 item per turn</small><br>
                                    <small style="color: #92400e;">Round ${gameState.placementRound} of 2</small><br>
                                    <small style="color: #059669;">Goal: 1 Waste Plant + 3 Roads per round</small>
                                </div>
                            `}
                            
                            <div class="message-box">${gameState.message}</div>
                            
                            ${gameState.phase === 1 ? `
                                <button class="btn btn-warning ${gameState.buildMode === 'wastePlant' ? 'active' : ''}"
                                    onclick="gameState.buildMode = 'wastePlant'; render()"
                                    ${gameState.buildMode !== 'wastePlant' ? 'disabled' : ''}>
                                    ${gameState.buildMode === 'wastePlant' ? '‚úÖ Place Waste Plant (Click on board)' : 'üè≠ Waste Plant'}
                                    <span class="cost-label">FREE</span>
                                </button>
                                
                                <button class="btn btn-warning ${gameState.buildMode === 'road' ? 'active' : ''}"
                                    onclick="gameState.buildMode = 'road'; render()"
                                    ${gameState.buildMode !== 'road' ? 'disabled' : ''}>
                                    ${gameState.buildMode === 'road' ? '‚úÖ Place Road (Click on board)' : 'üõ£Ô∏è Road'}
                                    <span class="cost-label">FREE</span>
                                </button>
                            ` : `
                                <button class="btn btn-warning ${gameState.buildMode === 'wastePlant' ? 'active' : ''}"
                                    onclick="gameState.buildMode = gameState.buildMode === 'wastePlant' ? null : 'wastePlant'; render()"
                                    ${!canAfford(player, 'wastePlant') ? 'disabled' : ''}>
                                    ${gameState.buildMode === 'wastePlant' ? '‚ùå Cancel' : 'üè≠ Build Waste Plant (1 VP)'}
                                    <span class="cost-label">üí∞ M1 üóëÔ∏è G1 ‚ö° E1 üìú L1</span>
                                </button>
                                
                                <button class="btn btn-warning ${gameState.buildMode === 'incinerationPlant' ? 'active' : ''}"
                                    onclick="gameState.buildMode = gameState.buildMode === 'incinerationPlant' ? null : 'incinerationPlant'; render()"
                                    ${!canAfford(player, 'incinerationPlant') ? 'disabled' : ''}>
                                    ${gameState.buildMode === 'incinerationPlant' ? '‚ùå Cancel' : 'üè¢ Build Incineration Plant (2 VP)'}
                                    <span class="cost-label">üóëÔ∏è G2 üí∞ M3 (Upgrade)</span>
                                </button>
                                
                                <button class="btn btn-warning ${gameState.buildMode === 'road' ? 'active' : ''}"
                                    onclick="gameState.buildMode = gameState.buildMode === 'road' ? null : 'road'; render()"
                                    ${!canAfford(player, 'road') ? 'disabled' : ''}>
                                    ${gameState.buildMode === 'road' ? '‚ùå Cancel' : 'üõ£Ô∏è Build Road'}
                                    <span class="cost-label">‚ö° E1 üìú L1</span>
                                </button>
                            
                                <button class="btn btn-info"
                                    onclick="buyDevCard()"
                                    ${!canAfford(player, 'devCard') ? 'disabled' : ''}>
                                    üé¥ Buy Development Card
                                    <span class="cost-label">üóëÔ∏è G1 ‚ö° E1 üí∞ M1</span>
                                </button>
                                
                                <button class="btn btn-success ${gameState.tradeMode ? 'active' : ''}"
                                    onclick="gameState.tradeMode = gameState.tradeMode ? null : 'bank'; render()">
                                    ${gameState.tradeMode ? '‚ùå Cancel Trade' : 'üè¶ Bank Trade (4:1)'}
                                </button>
                                
                                <button class="btn btn-secondary" onclick="endTurn()">
                                    ‚è≠Ô∏è End Turn
                                </button>
                            `}
                            
                            ${gameState.tradeMode === 'bank' ? `
                                <div class="trade-panel">
                                    ${!gameState.tradingResource ? `
                                        <div class="trade-title">Give 4 of:</div>
                                        <div class="trade-buttons">
                                            ${RESOURCES.map(r => `
                                                <button class="trade-btn" 
                                                    style="background: ${RESOURCE_COLORS[r]}"
                                                    onclick="startBankTrade('${r}')"
                                                    ${(player.resources[r] || 0) < 4 ? 'disabled' : ''}>
                                                    ${RESOURCE_NAMES[r]} (${player.resources[r] || 0})
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="trade-title">Receive 1 of:</div>
                                        <div class="trade-buttons">
                                            ${RESOURCES.map(r => `
                                                <button class="trade-btn" 
                                                    style="background: ${RESOURCE_COLORS[r]}"
                                                    onclick="completeBankTrade('${r}')">
                                                    ${RESOURCE_NAMES[r]}
                                                </button>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                            
                            ${player.devCards.length > 0 ? `
                                <div class="dev-cards-panel">
                                    <div class="dev-cards-title">Your Dev Cards:</div>
                                    <div class="dev-cards-list">
                                        ${player.devCards.map((card, idx) => `
                                            <button class="dev-card" 
                                                onclick="playDevCard('${card}')"
                                                ${card === 'victory' ? 'disabled' : ''}>
                                                ${card}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="control-card help-box">
                            <h4>üìñ How to Play:</h4>
                            ${gameState.phase === 1 ? `
                                <ul>
                                    <li><strong>Phase 1: Setup (Turn-based)</strong></li>
                                    <li>Players alternate placing 1 item at a time</li>
                                    <li>Each round: 1 Waste Plant + 3 Roads</li>
                                    <li>Round 1: Forward order (P1‚ÜíP2‚ÜíP3‚ÜíP4)</li>
                                    <li>Round 2: Reverse order (P4‚ÜíP3‚ÜíP2‚ÜíP1)</li>
                                    <li>Place roads anywhere on the board</li>
                                </ul>
                            ` : `
                                <ul>
                                    <li>Roll dice for resources</li>
                                    <li>Build Waste Plants (1 VP)</li>
                                    <li>Upgrade to Incineration Plants (2 VP)</li>
                                    <li>Buy & play dev cards</li>
                                    <li>Trade with bank (4:1)</li>
                                    <li>First to 10 VP wins!</li>
                                </ul>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderWinnerScreen() {
            return `
                <div class="winner-screen">
                    <h1>üéâ Victory! üéâ</h1>
                    <div class="winner-color" style="background: ${gameState.winner.color}"></div>
                    <div class="winner-name">${gameState.winner.name}</div>
                    <div class="winner-vp">‚≠ê ${gameState.winner.vp} Victory Points</div>
                    <button class="start-button" onclick="location.reload()">
                        New Game
                    </button>
                </div>
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            
            if (gameState.screen === 'setup') {
                app.innerHTML = renderSetupScreen();
            } else if (gameState.screen === 'game') {
                app.innerHTML = renderGameScreen();
            } else if (gameState.screen === 'winner') {
                app.innerHTML = renderWinnerScreen();
            }
        }
        
        function startGame() {
            gameState.players = initializePlayers(gameState.numPlayers);
            gameState.devCardDeck = createDevCardDeck();
            gameState.screen = 'game';
            gameState.phase = 1;
            gameState.placementRound = 1;
            gameState.currentPlayer = 0;
            gameState.buildMode = 'wastePlant';
            gameState.message = `üè≠ Phase 1: Initial Placement! ${gameState.players[0].name} places a Waste Plant. Click on a vertex on the board.`;
            render();
        }
        
        // Initial render
        render();
    </script>
</body>
</html>
